#### Importing Packages
```{r}
start_time <- Sys.time()
library("httr")
library("jsonlite")
library("openssl")
library("swat")
library("dplyr")
```


#### Establish Connection with CAS
#### Add user id and password .........................
```{r}
conn <- CAS("https://tdpoc.viya4.sasdemo.ca/cas-shared-default-http/", username='demo006', password='sas2023',protocol='http')
```

#### Connecting to CSV list folder
```{r}
# Loading Action Set
cas.builtins.loadActionSet(conn, actionset = "table")
#### Loading SQL action set to perform data manipulation : Everything computes in CAS
cas.builtins.loadActionSet(conn, actionset = "FedSQL")

# Getting CASLIB info
cas.table.caslibInfo(conn)

# Get file info for a CASLIB
cas.table.fileInfo(conn, caslib = 'public')

# Creating a new CASLIB, point to data folder | nfs -> files -> access-clients -> TD testing -> SAS POC DATA
result <- cas.table.addCaslib(conn,
  caslib="RCASLIB",
  description="R_connection_tester",
  dataSource=list(srcType="path"),
  path="/access-clients/TDtesting/SAS_POC_Data/")

# Getting Library Info
cas.table.caslibInfo(conn, caslib = "RCASLIB")

#getting a list of file information in the CASLIB
cas.table.fileInfo(conn, caslib = "RCASLIB")
```

### Loading CSVs to in-memory and making a new CASLIB in memory for R session
```{r}
# loading table function R SWAT in memory..

### ADD DATA HERE ----->
file_list <- c("2016Q1.csv", "2016Q2.csv","2016Q3.csv","2016Q4.csv",
               "2017Q1.csv", "2017Q2.csv","2017Q3.csv","2017Q4.csv",
               "2018Q1.csv", "2018Q2.csv","2018Q3.csv","2018Q4.csv",
               "2019Q1.csv", "2019Q2.csv","2019Q3.csv","2019Q4.csv",
               "2020Q1.csv", "2020Q2.csv","2020Q3.csv","2020Q4.csv",
               "2021Q1.csv", "2021Q2.csv", "2021Q3.csv","2021Q4.csv",
               "2022Q1.csv", "2022Q2.csv","2022Q3.csv","2022Q4.csv"
              )

for (indx in 1:length(file_list)){
  save_list <- paste("R",substr(file_list[indx], 1, 6), "_acq", sep = "")
  out_list <- paste("R", substr(file_list[indx], 1, 6), sep = "")
  query_table <- paste("R", substr(file_list[indx], 1, 6), "_CAS", sep ="")
  cas.table.loadTable(conn, path = file_list[indx], 
                                        importOptions = list(fileType="CSV", getNames = FALSE, delimiter = "|",vars = list(
                                                               list(name = "POOL_ID", type="char", length = 30),
                                                               list(name = "LOAN_ID", type="char", length = 30),
                                                               list(name = "ACT_PERIOD", type="char", length = 30),
                                                               list(name = "CHANNEL", type="char", length = 30),
                                                               list(name = "SELLER", type="char", length = 30),
                                                               list(name = "SERVICER", type="char", length = 30),
                                                               list(name = "MASTER_SERVICER", type="char", length = 30),
                                                               list(name = "ORIG_RATE", type="double"),
                                                               list(name = "CURR_RATE", type="double"),
                                                               list(name = "ORIG_UPB", type="double"),
                                                               list(name = "ISSUANCE_UPB", type="double"),
                                                               list(name = "CURRENT_UPB", type="double"),
                                                               list(name = "ORIG_TERM", type="double"),
                                                               list(name = "ORIG_DATE", type="char", length = 30),
                                                               list(name = "FIRST_PAY", type="char", length = 30),
                                                               list(name = "LOAN_AGE", type="double"),
                                                               list(name = "REM_MONTHS", type="double"),
                                                               list(name = "ADJ_REM_MONTHS", type="double"),
                                                               list(name = "MATR_DT", type="char", length = 30),
                                                               list(name = "OLTV", type="double"),
                                                               list(name = "OCLTV", type="double"),
                                                               list(name = "NUM_BO", type="char", length = 30),
                                                               list(name = "DTI", type="double"),
                                                               list(name = "CSCORE_B", type="double"),
                                                               list(name = "CSCORE_C", type="double"),
                                                               list(name = "FIRST_FLAG", type="char", length = 30),
                                                               list(name = "PURPOSE", type="char", length = 30),
                                                               list(name = "PROP", type="char", length = 30),
                                                               list(name = "NO_UNITS", type="double"),
                                                               list(name = "OCC_STAT", type="char", length = 30),
                                                               list(name = "STATE", type="char", length = 30),
                                                               list(name = "MSA", type="char", length = 30),
                                                               list(name = "ZIP", type="char", length = 30),
                                                               list(name = "MI_PCT", type="double"),
                                                               list(name = "PRODUCT", type="char", length = 30),
                                                               list(name = "PPMT_FLG", type="char", length = 30),
                                                               list(name = "IO", type="char", length = 30),
                                                               list(name = "FIRST_PAY_IO", type="char", length = 30),
                                                               list(name = "MNTHS_TO_AMTZ_IO", type="double"),
                                                               list(name = "DLQ_STATUS", type="char", length = 30),
                                                               list(name = "PMT_HISTORY", type="char", length = 30),
                                                               list(name = "MOD_FLAG", type="char", length = 30),
                                                               list(name = "MI_CANCEL_FLAG", type="char", length = 30),
                                                               list(name = "Zero_Bal_Code", type="char", length = 30),
                                                               list(name = "ZB_DTE", type="char", length = 30),
                                                               list(name = "LAST_UPB", type="double"),
                                                               list(name = "RPRCH_DTE", type="char", length = 30),
                                                               list(name = "CURR_SCHD_PRNCPL", type="double"),
                                                               list(name = "TOT_SCHD_PRNCPL", type="double"),
                                                               list(name = "UNSCHD_PRNCPL_CURR", type="double"),
                                                               list(name = "LAST_PAID_INSTALLMENT_DATE", type="char", length = 30),
                                                               list(name = "FORECLOSURE_DATE", type="char", length = 30),
                                                               list(name = "DISPOSITION_DATE", type="char", length = 30),
                                                               list(name = "FORECLOSURE_COSTS", type="double"),
                                                               list(name = "PROPERTY_PRESERVATION_AND_REPAIR_COSTS", type="double"),
                                                               list(name = "ASSET_RECOVERY_COSTS", type="double"),
                                                               list(name = "MISCELLANEOUS_HOLDING_EXPENSES_AND_CREDITS", type="double"),
                                                               list(name = "ASSOCIATED_TAXES_FOR_HOLDING_PROPERTY", type="double"),
                                                               list(name = "NET_SALES_PROCEEDS", type="double"),
                                                               list(name = "CREDIT_ENHANCEMENT_PROCEEDS", type="double"),
                                                               list(name = "REPURCHASES_MAKE_WHOLE_PROCEEDS", type="double"),
                                                               list(name = "OTHER_FORECLOSURE_PROCEEDS", type="double"),
                                                               list(name = "NON_INTEREST_BEARING_UPB", type="double"),
                                                               list(name = "PRINCIPAL_FORGIVENESS_AMOUNT", type="double"),
                                                               list(name = "ORIGINAL_LIST_START_DATE", type="char", length = 30),
                                                               list(name = "ORIGINAL_LIST_PRICE", type="double"),
                                                               list(name = "CURRENT_LIST_START_DATE", type="char", length = 30),
                                                               list(name = "CURRENT_LIST_PRICE", type="double"),
                                                               list(name = "ISSUE_SCOREB", type="double"),
                                                               list(name = "ISSUE_SCOREC", type="double"),
                                                               list(name = "CURR_SCOREB", type="double"),
                                                               list(name = "CURR_SCOREC", type="double"),
                                                               list(name = "MI_TYPE", type="double"),
                                                               list(name = "SERV_IND", type="char", length = 30),
                                                               list(name = "CURRENT_PERIOD_MODIFICATION_LOSS_AMOUNT", type="double"),
                                                               list(name = "CUMULATIVE_MODIFICATION_LOSS_AMOUNT", type="double"),
                                                               list(name = "CURRENT_PERIOD_CREDIT_EVENT_NET_GAIN_OR_LOSS", type="double"),
                                                               list(name = "CUMULATIVE_CREDIT_EVENT_NET_GAIN_OR_LOSS", type="double"),
                                                               list(name = "HOMEREADY_PROGRAM_INDICATOR", type="char", length = 30),
                                                               list(name = "FORECLOSURE_PRINCIPAL_WRITE_OFF_AMOUNT", type="double"),
                                                               list(name = "RELOCATION_MORTGAGE_INDICATOR", type="char", length = 30),
                                                               list(name = "ZERO_BALANCE_CODE_CHANGE_DATE", type="double"),
                                                               list(name = "LOAN_HOLDBACK_INDICATOR", type="char", length = 30),
                                                               list(name = "LOAN_HOLDBACK_EFFECTIVE_DATE", type="double"),
                                                               list(name = "DELINQUENT_ACCRUED_INTEREST", type="double"),
                                                               list(name = "PROPERTY_INSPECTION_WAIVER_INDICATOR", type="char", length = 30),
                                                               list(name = "HIGH_BALANCE_LOAN_INDICATOR", type="char", length = 30),
                                                               list(name = "ARM_5_YR_INDICATOR", type="double"),
                                                               list(name = "ARM_PRODUCT_TYPE", type="double"),
                                                               list(name = "MONTHS_UNTIL_FIRST_PAYMENT_RESET", type="double"),
                                                               list(name = "MONTHS_BETWEEN_SUBSEQUENT_PAYMENT_RESET", type="double"),
                                                               list(name = "INTEREST_RATE_CHANGE_DATE", type="double"),
                                                               list(name = "PAYMENT_CHANGE_DATE", type="double"),
                                                               list(name = "ARM_INDEX", type="double"),
                                                               list(name = "ARM_CAP_STRUCTURE", type="double"),
                                                               list(name = "INITIAL_INTEREST_RATE_CAP", type="double"),
                                                               list(name = "PERIODIC_INTEREST_RATE_CAP", type="double"),
                                                               list(name = "LIFETIME_INTEREST_RATE_CAP", type="double"),
                                                               list(name = "MARGIN", type="double"),
                                                               list(name = "BALLOON_INDICATOR", type="double"),
                                                               list(name = "PLAN_NUMBER", type="char", length = 30),
                                                               list(name = "FORBEARANCE_INDICATOR", type="char", length = 30),
                                                               list(name = "HIGH_LOAN_TO_VALUE_HLTV_REFINANCE_OPTION_INDICATOR", type="char", length = 30),
                                                               list(name = "DEAL_NAME", type="char", length = 30),
                                                               list(name = "RE_PROCS_FLAG", type="char", length = 30),
                                                               list(name = "ADR_TYPE", type="char", length = 30),
                                                               list(name = "ADR_COUNT", type="double"),
                                                               list(name = "ADR_UPB", type="double"))), casout = list(caslib = "RCASLIB", name = out_list, replace = TRUE))
                      acquisition_year <- substr(file_list[indx], 1, 4)
                      acquisition_qtr <- substr(file_list[indx], 5, 6)
                          if(acquisition_qtr == 'Q1'){
                             acquisition_month <- '03'
                        } else if(acquisition_qtr == 'Q2'){
                             acquisition_month <- '06'
                        } else if(acquisition_qtr == 'Q3'){
                             acquisition_month <- '09'
                        } else {
                             acquisition_month <- '12'
                        }
                     acquisition_date <- paste(acquisition_year, acquisition_month, '01', sep = "-")
                     df <- data.frame(filename = acquisition_date)
                     write.csv(df, file = file_list[indx])
                     cas.read.csv(conn, file = file_list[indx], casOut = list(name = save_list, caslib = "RCASLIB", replace = TRUE))
                     #### ADDING ACQ DATE COLUMN TO TABLES
                     paste_query <- paste("CREATE TABLE", query_table, "AS SELECT A.*, B.filename, CAST (B.FILENAME AS DATE) AS ACQUISITION_DATE FROM", out_list,                                     "A,", save_list, "B",sep = " ")
                     cas.fedSql.execDirect(conn, query = paste_query)
                     cas.table.dropTable(conn, name = save_list, caslib = "RCASLIB")
                     cas.table.dropTable(conn, name = out_list, caslib = "RCASLIB")
                                        }
```

#### ADDING ACQ DATE COLUMN TO TABLES
```{r}
#cas.fedSql.execDirect(conn, query ="CREATE TABLE R2021Q2_CAS AS SELECT A.*, B.filename, CAST (B.FILENAME AS DATE) AS ACQUISITION_DATE FROM R2021Q2 A, R2021Q2_ACQ B")
```

```{r}
for (indx in 2:length(file_list)){
  merged_list <- paste("R",substr(file_list[indx], 1, 6), "_CAS", sep = "")
  cas.table.append(conn, source = list(caslib = "RCASLIB", name = merged_list), target = list(caslib = "RCASLIB", name = "R2016Q1_CAS"))
  cas.table.dropTable(conn, caslib = "RCASLIB", name = merged_list)
} 
```

```{r}
#cas.table.loadTable(conn, )
```

```{r}
cas.table.fetch(conn, table = list(name = "R2016Q1_CAS", caslib = "RCASLIB"), to = 1000)
```

### Converting SAS date format .... 
#### Fetching the dataset

```{r}
cas.table.index(conn, table = list(caslib = "RCASLIB", name = "R2016Q1_CAS", 
                                   computedVarsProgram = "ACT_PERIOD_UPDATED = MDY(substr(act_period,1,2),1,substr(act_period,3,4));
                                                          FIRST_PAY_UPDATED = MDY(substr(first_pay,1,2),1,substr(first_pay,3,4));
                                                          ORIG_DATE_UPDATED = MDY(substr(orig_date,1,2),1,substr(orig_date,3,4));
                                                          ZB_DTE_UPDATED = MDY(substr(zb_dte,1,2),1,substr(zb_dte,3,4));
                                                          LPI_DTE_UPDATED = MDY(substr(LAST_PAID_INSTALLMENT_DATE,1,2),1,substr(LAST_PAID_INSTALLMENT_DATE,3,4));
                                                          FCC_DTE_UPDATED = MDY(substr(FORECLOSURE_DATE,1,2),1,substr(FORECLOSURE_DATE,3,4));
                                                          DISP_DTE_UPDATED = MDY(substr(DISPOSITION_DATE,1,2),1,substr(DISPOSITION_DATE,3,4));"),
                casout = list(name = "Formatted_data", caslib = "RCASLIB", replace = TRUE))
```

#### Display the final Results
```{r}
cas.table.dropTable(conn, caslib = "RCASLIB", name = "R2016Q1_CAS")
```
```{r}
cas.table.head()
```

### LPPUB BASE DATASET
### Select and rename key columns for statistical summary analysis

```{r}
cas.table.copyTable(conn, table = list(name = "Formatted_data", caslib = "RCASLIB"), casout = list(caslib = "RCASLIB", name = "LPPUB_BASE_CAS", replace = TRUE))

LPPUB_BASE_CAS <- cas.table.alterTable(conn, caslib = "RCASLIB", 
                            name = "LPPUB_BASE_CAS",
                     keep = list("ACT_PERIOD_UPDATED", "FIRST_PAY_UPDATED", "ORIG_DATE_UPDATED", "LOAN_ID", "ACT_PERIOD", "CHANNEL", "SELLER", "SERVICER", "ORIG_RATE", "CURR_RATE", "ORIG_UPB", "CURRENT_UPB", "ORIG_TERM", "ORIG_DATE", "FIRST_PAY", "LOAN_AGE", "REM_MONTHS", "ADJ_REM_MONTHS", "MATR_DT", "OLTV", "OCLTV", "NUM_BO", "DTI", "CSCORE_B", "CSCORE_C", "FIRST_FLAG", "PURPOSE", "PROP", "NO_UNITS", "OCC_STAT", "STATE", "MSA", "ZIP", "MI_PCT", "PRODUCT", "DLQ_STATUS", "MOD_FLAG", "Zero_Bal_Code", "ZB_DTE", "LAST_PAID_INSTALLMENT_DATE", "FORECLOSURE_DATE", "DISPOSITION_DATE", "FORECLOSURE_COSTS", "PROPERTY_PRESERVATION_AND_REPAIR_COSTS", "ASSET_RECOVERY_COSTS", "MISCELLANEOUS_HOLDING_EXPENSES_AND_CREDITS", "ASSOCIATED_TAXES_FOR_HOLDING_PROPERTY", "NET_SALES_PROCEEDS", "CREDIT_ENHANCEMENT_PROCEEDS", "REPURCHASES_MAKE_WHOLE_PROCEEDS", "OTHER_FORECLOSURE_PROCEEDS", "NON_INTEREST_BEARING_UPB", "PRINCIPAL_FORGIVENESS_AMOUNT", "RELOCATION_MORTGAGE_INDICATOR", "MI_TYPE", "SERV_IND", "RPRCH_DTE", "LAST_UPB"))

cas.table.fetch(conn, table = list(name = 'LPPUB_BASE_CAS', caslib = "RCASLIB"))
```

### ACQUISITION FILE
### Select and rename key columns for statistical summary analysis
```{r}
cas.table.copyTable(conn, table = list(name = "Formatted_data", caslib = "RCASLIB"), casout = list(caslib = "RCASLIB", name = "ACQUISITION_FILE_CAS", replace = TRUE))

ACQUISITION_FILE_CAS <- cas.table.alterTable(conn, caslib = "RCASLIB", name = "ACQUISITION_FILE_CAS",
                                             columns = list(list(name = "CHANNEL", rename = "ORIG_CHN"),
                                                            list(name = "ORIG_RATE", rename = "ORIG_RT"),
                                                            list(name = "ORIG_UPB", rename = "ORIG_AMT"),
                                                            list(name = "ORIG_TERM", rename = "ORIG_TRM"),
                                                            list(name = "FIRST_FLAG", rename = "FTHB_FLG"),
                                                            list(name = "PROP", rename = "PROP_TYP"),
                                                            list(name = "NO_UNITS", rename = "NUM_UNIT"),
                                                            list(name = "ZIP", rename = "ZIP_3"),
                                                            list(name = "PRODUCT", rename = "PROD_TYPE"),
                                                            list(name = "RELOCATION_MORTGAGE_INDICATOR", rename = "RELO_FLG")), keep = list("LOAN_ID", "ACT_PERIOD_UPDATED", 
                                                            "ORIG_CHN", "SELLER", "ORIG_RT", "ORIG_AMT", "ORIG_TRM", "ORIG_DATE_UPDATED", "FIRST_PAY_UPDATED", "OLTV",
                                                            "OCLTV", "NUM_BO",
                                                            "DTI", "CSCORE_B", "CSCORE_C", "FTHB_FLG", "PURPOSE", "PROP_TYP", "NUM_UNIT", "OCC_STAT", "STATE", "ZIP_3",
                                                            "MI_PCT", "PROD_TYPE", "MI_TYPE", "RELO_FLG", "ACQUISITION_DATE"))
```

```{r}
cas.table.dropTable(conn, name = 'Formatted_data', caslib = "RCASLIB")
```


#### ACQ FIRST PERIOD 
```{r}
cas.table.copyTable(conn, table = list(name = "ACQUISITION_FILE_CAS", caslib = "RCASLIB"), casout = list(caslib = "RCASLIB", name = "ACQFIRSTPERIOD_1", replace = TRUE))

cas.fedSql.execDirect(conn, query = "CREATE TABLE ACQFIRSTPERIOD_SQL 
                      AS 
                      SELECT
                      ACQFIRSTPERIOD_1.LOAN_ID as LOAD_ID_short, MIN(ACQFIRSTPERIOD_1.ACT_PERIOD_UPDATED) as                                             ACT_PERIOD_UPDATED_min
                      FROM ACQFIRSTPERIOD_1
                      GROUP BY ACQFIRSTPERIOD_1.LOAN_ID;")

cas.fedSql.execDirect(conn, query = "                      CREATE TABLE acqFirstPeriod AS SELECT * FROM  ACQFIRSTPERIOD_SQL inner join ACQFIRSTPERIOD_1 on (ACQFIRSTPERIOD_SQL.LOAD_ID_short = ACQFIRSTPERIOD_1.LOAN_ID AND ACQFIRSTPERIOD_SQL.ACT_PERIOD_UPDATED_min = ACQFIRSTPERIOD_1.ACT_PERIOD_UPDATED);")

cas.table.dropTable(conn, name = 'ACQFIRSTPERIOD_SQL', caslib = "RCASLIB")
cas.table.dropTable(conn, name = 'ACQFIRSTPERIOD_1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'ACQFIRSTPERIOD', caslib = "RCASLIB"), to = 100)
```

#### PERFORMANCE FILES
```{r}
cas.table.copyTable(conn, table = list(name = "LPPUB_BASE_CAS", caslib = "RCASLIB"), casout = list(caslib = "RCASLIB", name = "PERFORMANCE_FILE_CAS", replace = TRUE))

PERFORMANCE_FILE_CAS <- cas.table.alterTable(conn, caslib = "RCASLIB", name = "PERFORMANCE_FILE_CAS",
                                             columns = list(list(name = "ACT_PERIOD_UPDATED", rename = "period"),
                                                            list(name = "CURR_RATE", rename = "curr_rte"),
                                                            list(name = "CURRENT_UPB", rename = "act_upb"),
                                                            list(name = "REM_MONTHS", rename = "rem_mths"),
                                                            list(name = "MATR_DT", rename = "maturity_date"),
                                                            list(name = "MOD_FLAG", rename = "mod_ind"),
                                                            list(name = "Zero_Bal_Code", rename = "z_zb_code"),
                                                            list(name = "ZB_DTE", rename = "zb_date"),
                                                            list(name = "LAST_PAID_INSTALLMENT_DATE", rename = "lpi_dte"),
                                                            list(name = "FORECLOSURE_DATE", rename = "fcc_dte"),
                                                            list(name = "DISPOSITION_DATE", rename = "disp_dte"),
                                                            list(name = "FORECLOSURE_COSTS", rename = "FCC_COST"),
                                                            list(name = "PROPERTY_PRESERVATION_AND_REPAIR_COSTS", rename = "PP_COST"),
                                                            list(name = "ASSET_RECOVERY_COSTS", rename = "AR_COST"),
                                                            list(name = "MISCELLANEOUS_HOLDING_EXPENSES_AND_CREDITS", rename = "IE_COST"),
                                                            list(name = "ASSOCIATED_TAXES_FOR_HOLDING_PROPERTY", rename = "TAX_COST"),
                                                            list(name = "NET_SALES_PROCEEDS", rename = "NS_PROCS"),
                                                            list(name = "CREDIT_ENHANCEMENT_PROCEEDS", rename = "CE_PROCS"),
                                                            list(name = "REPURCHASES_MAKE_WHOLE_PROCEEDS", rename = "RMW_PROCS"),
                                                            list(name = "OTHER_FORECLOSURE_PROCEEDS", rename = "O_PROCS"),
                                                            list(name = "NON_INTEREST_BEARING_UPB", rename = "non_int_upb"),
                                                            list(name = "PRINCIPAL_FORGIVENESS_AMOUNT", rename = "prin_forg_upb"),
                                                            list(name = "LAST_UPB", rename = "zb_upb")), 
                                             keep = list("LOAN_ID", "period", "servicer", "curr_rte", "act_upb", "loan_age", "rem_mths", "adj_rem_months", "maturity_date", "msa", "dlq_status", "mod_ind", "z_zb_code", "zb_date", "lpi_dte", "fcc_dte", "disp_dte", "FCC_COST", "PP_COST", "AR_COST", "IE_COST", "TAX_COST", "NS_PROCS", "CE_PROCS", "RMW_PROCS", "O_PROCS", "non_int_upb", "prin_forg_upb", "zb_upb"))

cas.table.fetch(conn, table = list(name = 'PERFORMANCE_FILE_CAS', caslib = "RCASLIB"), to = 100)
cas.table.dropTable(conn, name = 'LPPUB_BASE_CAS', caslib = "RCASLIB")
```

#### Acq date and basetable 1 sql

```{r}
#cas.table.dropTable(conn, name = 'BASETABLE1', caslib = "RCASLIB")
cas.fedSql.execDirect(conn, query = " CREATE TABLE BASETABLE1 AS SELECT ACQUISITION_DATE, ORIG_AMT, LOAN_ID, ORIG_CHN, 
                                      CASE 
                                          WHEN MI_TYPE = 1 THEN 'BPMI'
                                          WHEN MI_TYPE = 2 THEN 'LPMI'
                                          WHEN MI_TYPE = 3 THEN 'IPMI'
                                          ELSE 'NONE'
                                      END AS MI_TYPE, 
                                      CASE 
                                        WHEN OCLTV IS NULL THEN OLTV
                                        ELSE OCLTV
                                      END AS OCLTV
                                      FROM ACQUISITION_FILE_CAS") 
cas.table.fetch(conn, table = list(name = 'BASETABLE1', caslib = "RCASLIB"), to = 1000)
```

#### Creating second basetable
```{r}
#### LAST_ACT_DTE_TABLE
cas.fedSql.execDirect(conn, query = "CREATE TABLE LAST_ACT_DTE_TABLE AS SELECT LOAN_ID, max(PERFORMANCE_FILE_CAS.PERIOD) as 
LAST_ACTIVITY_DATE FROM PERFORMANCE_FILE_CAS GROUP BY PERFORMANCE_FILE_CAS.LOAN_ID;")
```

```{r}
#### LAST_UPB_TABLE
cas.fedSql.execDirect(conn, query = "CREATE TABLE LAST_UPB_TABLE_S1 AS SELECT LOAN_ID,
                                     max(PERFORMANCE_FILE_CAS.PERIOD) as LAST_UPB_DTE 
                                     FROM PERFORMANCE_FILE_CAS
                                     WHERE (PERFORMANCE_FILE_CAS.ACT_UPB IS NOT NULL AND PERFORMANCE_FILE_CAS.ACT_UPB > 0)
                                     GROUP BY PERFORMANCE_FILE_CAS.LOAN_ID;")

cas.fedSql.execDirect(conn, query = "CREATE TABLE LAST_UPB_TABLE 
                                     AS SELECT LAST_UPB_TABLE_S1.LOAN_ID, LAST_UPB_TABLE_S1.LAST_UPB_DTE, 
                                     PERFORMANCE_FILE_CAS.ACT_UPB AS LAST_UPB
                                     FROM RCASLIB.LAST_UPB_TABLE_S1 LEFT JOIN RCASLIB.PERFORMANCE_FILE_CAS
                                     ON LAST_UPB_TABLE_S1.LOAN_ID  = PERFORMANCE_FILE_CAS.LOAN_ID AND 
                                     LAST_UPB_TABLE_S1.LAST_UPB_DTE  = PERFORMANCE_FILE_CAS.PERIOD;")

cas.table.dropTable(conn, name = 'LAST_UPB_TABLE_S1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'LAST_UPB_TABLE', caslib = "RCASLIB"), to = 100)
```
 
```{r}
#### LAST_RT_TABLE
cas.fedSql.execDirect(conn, query = "CREATE TABLE LAST_RT_TABLE_S1 AS SELECT LOAN_ID,
                                     max(PERFORMANCE_FILE_CAS.PERIOD) as LAST_RT_DTE 
                                     FROM PERFORMANCE_FILE_CAS
                                     WHERE (PERFORMANCE_FILE_CAS.CURR_RTE IS NOT NULL)
                                     GROUP BY PERFORMANCE_FILE_CAS.LOAN_ID;")

cas.fedSql.execDirect(conn, query = "CREATE TABLE LAST_RT_TABLE 
                                     AS SELECT LAST_RT_TABLE_S1.LOAN_ID, LAST_RT_TABLE_S1.LAST_RT_DTE, 
                                     PERFORMANCE_FILE_CAS.CURR_RTE AS LAST_RT
                                     FROM RCASLIB.LAST_RT_TABLE_S1 LEFT JOIN RCASLIB.PERFORMANCE_FILE_CAS
                                     ON LAST_RT_TABLE_S1.LOAN_ID  = PERFORMANCE_FILE_CAS.LOAN_ID AND 
                                     LAST_RT_TABLE_S1.LAST_RT_DTE  = PERFORMANCE_FILE_CAS.PERIOD;")

cas.table.dropTable(conn, name = 'LAST_RT_TABLE_S1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'LAST_RT_TABLE', caslib = "RCASLIB"), to = 100)
```

```{r}
#### ZB_CODE_TABLE
cas.fedSql.execDirect(conn, query = "CREATE TABLE ZB_CODE_TABLE_S1 AS SELECT LOAN_ID,
                                     max(PERFORMANCE_FILE_CAS.PERIOD) as ZB_CODE_DT 
                                     FROM PERFORMANCE_FILE_CAS
                                     WHERE (PERFORMANCE_FILE_CAS.Z_ZB_CODE IS NOT NULL)
                                     GROUP BY PERFORMANCE_FILE_CAS.LOAN_ID;")

cas.fedSql.execDirect(conn, query = "CREATE TABLE ZB_CODE_TABLE 
                                     AS SELECT ZB_CODE_TABLE_S1.LOAN_ID, ZB_CODE_TABLE_S1.ZB_CODE_DT, 
                                     PERFORMANCE_FILE_CAS.Z_ZB_CODE AS ZB_CODE
                                     FROM RCASLIB.ZB_CODE_TABLE_S1 LEFT JOIN RCASLIB.PERFORMANCE_FILE_CAS
                                     ON ZB_CODE_TABLE_S1.LOAN_ID  = PERFORMANCE_FILE_CAS.LOAN_ID AND 
                                     ZB_CODE_TABLE_S1.ZB_CODE_DT  = PERFORMANCE_FILE_CAS.PERIOD;")

cas.table.dropTable(conn, name = 'ZB_CODE_TABLE_S1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'ZB_CODE_TABLE', caslib = "RCASLIB"), to = 100)
```

```{r}
## MAX_TABLE
cas.fedSql.execDirect(conn, query = "CREATE TABLE T1 AS SELECT LAST_ACT_DTE_TABLE.LAST_ACTIVITY_DATE, PERFORMANCE_FILE_CAS.* 
                                     FROM LAST_ACT_DTE_TABLE LEFT JOIN PERFORMANCE_FILE_CAS 
                                     ON LAST_ACT_DTE_TABLE.LOAN_ID = PERFORMANCE_FILE_CAS.LOAN_ID AND 
                                     LAST_ACT_DTE_TABLE.LAST_ACTIVITY_DATE = PERFORMANCE_FILE_CAS.PERIOD;")
```

```{r}

cas.fedSql.execDirect(conn, query = "CREATE TABLE T2 AS SELECT T1.*, LAST_UPB_TABLE.LAST_UPB_DTE, LAST_UPB_TABLE.LAST_UPB  
                                     FROM T1 LEFT JOIN LAST_UPB_TABLE 
                                     ON T1.LOAN_ID = LAST_UPB_TABLE.LOAN_ID;")

cas.fedSql.execDirect(conn, query = "CREATE TABLE T3 AS SELECT T2.*, LAST_RT_TABLE.LAST_RT_DTE, LAST_RT_TABLE.LAST_RT  
                                     FROM T2 LEFT JOIN LAST_RT_TABLE 
                                     ON T2.LOAN_ID = LAST_RT_TABLE.LOAN_ID;")

cas.fedSql.execDirect(conn, query = "CREATE TABLE MAX_TABLE AS SELECT T3.*, ZB_CODE_TABLE.ZB_CODE_DT, ZB_CODE_TABLE.ZB_CODE 
                                     FROM T3 LEFT JOIN ZB_CODE_TABLE 
                                     ON T3.LOAN_ID = ZB_CODE_TABLE.LOAN_ID;")

cas.table.dropTable(conn, name = 'T1', caslib = "RCASLIB")
cas.table.dropTable(conn, name = 'T2', caslib = "RCASLIB")
cas.table.dropTable(conn, name = 'T3', caslib = "RCASLIB")
cas.table.dropTable(conn, name = 'LAST_ACT_DTE_TABLE', caslib = "RCASLIB")
cas.table.dropTable(conn, name = 'LAST_UPB_TABLE', caslib = "RCASLIB")
cas.table.dropTable(conn, name = 'LAST_RT_TABLE', caslib = "RCASLIB")
cas.table.dropTable(conn, name = 'ZB_CODE_TABLE', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'MAX_TABLE', caslib = "RCASLIB"), to = 100)
```

```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE SERVICER_TABLE_S1 AS SELECT LOAN_ID,
                                     max(PERFORMANCE_FILE_CAS.PERIOD) as SERVICER_PERIOD 
                                     FROM PERFORMANCE_FILE_CAS
                                     WHERE (PERFORMANCE_FILE_CAS.SERVICER IS NOT NULL)
                                     GROUP BY PERFORMANCE_FILE_CAS.LOAN_ID;")

cas.fedSql.execDirect(conn, query = "CREATE TABLE SERVICER_TABLE 
                                     AS SELECT SERVICER_TABLE_S1.LOAN_ID, SERVICER_TABLE_S1.SERVICER_PERIOD, 
                                     PERFORMANCE_FILE_CAS.SERVICER AS SERVICER_NEW
                                     FROM RCASLIB.SERVICER_TABLE_S1 LEFT JOIN RCASLIB.PERFORMANCE_FILE_CAS
                                     ON SERVICER_TABLE_S1.LOAN_ID  = PERFORMANCE_FILE_CAS.LOAN_ID AND 
                                     SERVICER_TABLE_S1.SERVICER_PERIOD  = PERFORMANCE_FILE_CAS.PERIOD;")

cas.table.dropTable(conn, name = 'SERVICER_TABLE_S1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'SERVICER_TABLE', caslib = "RCASLIB"), to = 100)
```

```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE NON_INT_UPB_TABLE_S1 AS SELECT *,  
                      CASE 
                        WHEN NON_INT_UPB IS NULL THEN 0
                        ELSE NON_INT_UPB END AS NON_INT_UPB_UPDATED FROM PERFORMANCE_FILE_CAS;")

cas.fedSql.execDirect(conn, query = "CREATE TABLE NON_INT_UPB_TABLE AS SELECT LOAN_ID, MAX(NON_INT_UPB_UPDATED) AS NON_INT_UPB_NEW FROM NON_INT_UPB_TABLE_S1 GROUP BY LOAN_ID")

cas.table.dropTable(conn, name = 'NON_INT_UPB_TABLE_S1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'NON_INT_UPB_TABLE', caslib = "RCASLIB"), to = 1000)
```

#### BASETABLE 2
```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE BASETABLE_2 AS SELECT BASETABLE1.ORIG_AMT,     
                                     NON_INT_UPB_TABLE.NON_INT_UPB_NEW,
                                     SERVICER_TABLE.SERVICER_NEW, SERVICER_TABLE.SERVICER_PERIOD,
                                     MAX_TABLE.*
                                     FROM BASETABLE1
                                     LEFT JOIN MAX_TABLE
                                     ON MAX_TABLE.LOAN_ID = BASETABLE1.LOAN_ID
                                     LEFT JOIN SERVICER_TABLE  
                                     ON BASETABLE1.LOAN_ID = SERVICER_TABLE.LOAN_ID
                                     LEFT JOIN NON_INT_UPB_TABLE
                                     ON BASETABLE1.LOAN_ID = NON_INT_UPB_TABLE.LOAN_ID")
cas.table.fetch(conn, table = list(name = 'BASETABLE_2', caslib = "RCASLIB"), to = 1000)
cas.table.dropTable(conn, name = 'MAX_TABLE', caslib = "RCASLIB")
cas.table.dropTable(conn, name = 'SERVICER_TABLE', caslib = "RCASLIB")
cas.table.dropTable(conn, name = 'NON_INT_UPB_TABLE', caslib = "RCASLIB")
```


#### BASETABLE 3 LOGIC
```{r}
# FCC TABLE
cas.fedSql.execDirect(conn, query = "CREATE TABLE FCC_TABLE_S1 AS SELECT PERFORMANCE_FILE_CAS.* 
                                     FROM PERFORMANCE_FILE_CAS 
                                     WHERE PERFORMANCE_FILE_CAS.LPI_DTE IS NOT NULL AND PERFORMANCE_FILE_CAS.FCC_DTE IS NOT NULL 
                                     AND PERFORMANCE_FILE_CAS.DISP_DTE IS NOT NULL;")

cas.fedSql.execDirect(conn, query = "CREATE TABLE FCC_TABLE AS SELECT LOAN_ID, MAX(LPI_DTE) AS LPI_DTE, MAX(FCC_DTE) AS FCC_DTE, MAX(DISP_DTE) AS DISP_DTE
                                     FROM FCC_TABLE_S1 GROUP BY LOAN_ID;")

cas.table.dropTable(conn, name = 'FCC_TABLE_S1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'FCC_TABLE', caslib = "RCASLIB"), to = 100)
```

#### BASETABLE 3
```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE BASETABLE_3 AS SELECT BASETABLE_2.*,                                              FCC_TABLE.LPI_DTE AS LPI_DTE_UPDATED, 
                                     FCC_TABLE.FCC_DTE AS FCC_DTE_UPDATED, 
                                     FCC_TABLE.DISP_DTE AS DISP_DTE_UPDATED
                                     FROM BASETABLE_2 LEFT JOIN FCC_TABLE ON
                                     FCC_TABLE.LOAN_ID = BASETABLE_2.LOAN_ID")
cas.table.fetch(conn, table = list(name = 'BASETABLE_3', caslib = "RCASLIB"), to = 100)
cas.table.dropTable(conn, name = 'BASETABLE_2', caslib = "RCASLIB")
cas.table.dropTable(conn, name = 'FCC_TABLE', caslib = "RCASLIB")
```

### Create the series of "first DQ occurence" tables and loan modification tables
```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE SLIM_PERFORMANCE_FILE AS 
                                     SELECT LOAN_ID, PERIOD, 
                                     Z_ZB_CODE, ACT_UPB, MOD_IND, MATURITY_DATE, REM_MTHS, ZB_UPB,
                                     DLQ_STATUS, 
                                     CASE
                                          WHEN DLQ_STATUS = 'XX' THEN 999
                                          ELSE CAST(DLQ_STATUS AS INT)
                                     END AS DLQ_STATUS_UPDATED
                                     FROM PERFORMANCE_FILE_CAS;")
cas.table.fetch(conn, table = list(name = 'SLIM_PERFORMANCE_FILE', caslib = "RCASLIB"), to = 1000)
```

```{r}
### F30 TABLE
cas.fedSql.execDirect(conn, query = "CREATE TABLE F30_TABLE_S1 AS 
                                     SELECT LOAN_ID, MIN(PERIOD) AS F30_DTE 
                                     FROM SLIM_PERFORMANCE_FILE   
                                     WHERE DLQ_STATUS >= 1 AND DLQ_STATUS <= 999 AND Z_ZB_CODE IS NULL
                                     GROUP BY LOAN_ID;")
cas.fedSql.execDirect(conn, query = "CREATE TABLE F30_TABLE AS 
                                     SELECT PERFORMANCE_FILE_CAS.LOAN_ID, F30_TABLE_S1.F30_DTE, PERFORMANCE_FILE_CAS.ACT_UPB AS F30_UPB
                                     FROM F30_TABLE_S1 LEFT JOIN PERFORMANCE_FILE_CAS 
                                     ON PERFORMANCE_FILE_CAS.LOAN_ID = F30_TABLE_S1.LOAN_ID AND PERFORMANCE_FILE_CAS.PERIOD = F30_TABLE_S1.F30_DTE;")
cas.table.dropTable(conn, name = 'F30_TABLE_S1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'F30_TABLE', caslib = "RCASLIB"), to = 1000)
```

```{r}
### F60 TABLE
cas.fedSql.execDirect(conn, query = "CREATE TABLE F60_TABLE_S1 AS 
                                     SELECT LOAN_ID, MIN(PERIOD) AS F60_DTE 
                                     FROM SLIM_PERFORMANCE_FILE   
                                     WHERE DLQ_STATUS >= 2 AND DLQ_STATUS <= 999 AND Z_ZB_CODE IS NULL
                                     GROUP BY LOAN_ID;")
cas.fedSql.execDirect(conn, query = "CREATE TABLE F60_TABLE AS 
                                     SELECT PERFORMANCE_FILE_CAS.LOAN_ID, F60_TABLE_S1.F60_DTE, PERFORMANCE_FILE_CAS.ACT_UPB AS F60_UPB
                                     FROM F60_TABLE_S1 LEFT JOIN PERFORMANCE_FILE_CAS 
                                     ON PERFORMANCE_FILE_CAS.LOAN_ID = F60_TABLE_S1.LOAN_ID AND PERFORMANCE_FILE_CAS.PERIOD = F60_TABLE_S1.F60_DTE;")
cas.table.dropTable(conn, name = 'F60_TABLE_S1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'F60_TABLE', caslib = "RCASLIB"), to = 1000)
```

```{r}
### F90 TABLE
cas.fedSql.execDirect(conn, query = "CREATE TABLE F90_TABLE_S1 AS 
                                     SELECT LOAN_ID, MIN(PERIOD) AS F90_DTE 
                                     FROM SLIM_PERFORMANCE_FILE   
                                     WHERE DLQ_STATUS >= 3 AND DLQ_STATUS <= 999 AND Z_ZB_CODE IS NULL
                                     GROUP BY LOAN_ID;")
cas.fedSql.execDirect(conn, query = "CREATE TABLE F90_TABLE AS 
                                     SELECT PERFORMANCE_FILE_CAS.LOAN_ID, F90_TABLE_S1.F90_DTE, PERFORMANCE_FILE_CAS.ACT_UPB AS F90_UPB
                                     FROM F90_TABLE_S1 LEFT JOIN PERFORMANCE_FILE_CAS 
                                     ON PERFORMANCE_FILE_CAS.LOAN_ID = F90_TABLE_S1.LOAN_ID AND PERFORMANCE_FILE_CAS.PERIOD = F90_TABLE_S1.F90_DTE;")
cas.table.dropTable(conn, name = 'F90_TABLE_S1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'F90_TABLE', caslib = "RCASLIB"), to = 1000)
```

```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE F120_TABLE_S1 AS 
                                     SELECT LOAN_ID, MIN(PERIOD) AS F120_DTE 
                                     FROM SLIM_PERFORMANCE_FILE   
                                     WHERE DLQ_STATUS >= 4 AND DLQ_STATUS <= 999 AND Z_ZB_CODE IS NULL
                                     GROUP BY LOAN_ID;")
cas.fedSql.execDirect(conn, query = "CREATE TABLE F120_TABLE AS 
                                     SELECT PERFORMANCE_FILE_CAS.LOAN_ID, F120_TABLE_S1.F120_DTE, PERFORMANCE_FILE_CAS.ACT_UPB AS F120_UPB
                                     FROM F120_TABLE_S1 LEFT JOIN PERFORMANCE_FILE_CAS 
                                     ON PERFORMANCE_FILE_CAS.LOAN_ID = F120_TABLE_S1.LOAN_ID AND PERFORMANCE_FILE_CAS.PERIOD = F120_TABLE_S1.F120_DTE;")
cas.table.dropTable(conn, name = 'F120_TABLE_S1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'F120_TABLE', caslib = "RCASLIB"), to = 1000)
```

```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE F180_TABLE_S1 AS 
                                     SELECT LOAN_ID, MIN(PERIOD) AS F180_DTE 
                                     FROM SLIM_PERFORMANCE_FILE   
                                     WHERE DLQ_STATUS >= 6 AND DLQ_STATUS <= 999 AND Z_ZB_CODE IS NULL
                                     GROUP BY LOAN_ID;")
cas.fedSql.execDirect(conn, query = "CREATE TABLE F180_TABLE AS 
                                     SELECT PERFORMANCE_FILE_CAS.LOAN_ID, F180_TABLE_S1.F180_DTE, PERFORMANCE_FILE_CAS.ACT_UPB AS F180_UPB
                                     FROM F180_TABLE_S1 LEFT JOIN PERFORMANCE_FILE_CAS 
                                     ON PERFORMANCE_FILE_CAS.LOAN_ID = F180_TABLE_S1.LOAN_ID AND PERFORMANCE_FILE_CAS.PERIOD = F180_TABLE_S1.F180_DTE;")
cas.table.dropTable(conn, name = 'F180_TABLE_S1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'F180_TABLE', caslib = "RCASLIB"), to = 1000)
```



```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE FCE_TABLE_S1 AS SELECT LOAN_ID, MIN(PERIOD) AS FCE_DTE FROM
                                     SLIM_PERFORMANCE_FILE WHERE Z_ZB_CODE = '02' OR Z_ZB_CODE = '03' OR Z_ZB_CODE = '09' OR Z_ZB_CODE = '15' OR 
                                     (DLQ_STATUS >= 6 AND DLQ_STATUS < 999) GROUP BY LOAN_ID;")
cas.fedSql.execDirect(conn, query = "CREATE TABLE FCE_TABLE AS 
                                     SELECT FCE_TABLE_S1.LOAN_ID, FCE_TABLE_S1.FCE_DTE, 
                                     (SLIM_PERFORMANCE_FILE.ZB_UPB + SLIM_PERFORMANCE_FILE.ACT_UPB) AS FCE_UPB
                                     FROM FCE_TABLE_S1 LEFT JOIN SLIM_PERFORMANCE_FILE 
                                     ON SLIM_PERFORMANCE_FILE.LOAN_ID = FCE_TABLE_S1.LOAN_ID AND SLIM_PERFORMANCE_FILE.PERIOD = FCE_TABLE_S1.FCE_DTE;")
cas.table.dropTable(conn, name = 'FCE_TABLE_S1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'FCE_TABLE', caslib = "RCASLIB"), to = 1000)
```

```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE FMOD_DTE_TABLE AS 
                                     SELECT LOAN_ID, MIN(PERIOD) AS FMOD_DTE
                                     FROM SLIM_PERFORMANCE_FILE
                                     WHERE MOD_IND = 'Y' AND Z_ZB_CODE IS NULL
                                     GROUP BY LOAN_ID;")
cas.table.fetch(conn, table = list(name = 'FMOD_DTE_TABLE', caslib = "RCASLIB"), to = 1000)
```

```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE FMOD_P1 AS SELECT LOAN_ID, MAX(ACT_UPB) AS FMOD_UPB, MIN(PERIOD) AS PERIOD_NEW  FROM SLIM_PERFORMANCE_FILE 
                                     WHERE MOD_IND = 'Y' AND Z_ZB_CODE IS NULL GROUP BY LOAN_ID")
cas.fedSql.execDirect(conn, query = "CREATE TABLE FMOD_P2 AS SELECT FMOD_DTE_TABLE.LOAN_ID, FMOD_P1.FMOD_UPB, 
                                     FMOD_P1.PERIOD_NEW, FMOD_DTE_TABLE.FMOD_DTE FROM FMOD_P1
                                     LEFT JOIN FMOD_DTE_TABLE ON FMOD_P1.LOAN_ID = FMOD_DTE_TABLE.LOAN_ID
                                     WHERE ((FMOD_P1.PERIOD_NEW/30.45) <= ((FMOD_DTE_TABLE.FMOD_DTE/30.45) + 3));")
cas.fedSql.execDirect(conn, query = "CREATE TABLE FMOD_P3 AS SELECT FMOD_P2.LOAN_ID, FMOD_P2.FMOD_UPB, FMOD_P2.FMOD_DTE, SLIM_PERFORMANCE_FILE.MATURITY_DATE
                                     FROM FMOD_P2 LEFT JOIN SLIM_PERFORMANCE_FILE 
                                     ON SLIM_PERFORMANCE_FILE.LOAN_ID = FMOD_P2.LOAN_ID AND SLIM_PERFORMANCE_FILE.PERIOD = FMOD_P2.FMOD_DTE")
cas.table.dropTable(conn, name = 'FMOD_P1', caslib = "RCASLIB")
cas.table.dropTable(conn, name = 'FMOD_P2', caslib = "RCASLIB")
cas.table.dropTable(conn, name = 'FMOD_DTE_TABLE', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'FMOD_P3', caslib = "RCASLIB"), to = 1000)
```

```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE NUM_120_TABLE AS SELECT F120_TABLE.LOAN_ID, 
                                     ((F120_TABLE.F120_DTE/30.45)-(FIRST_PAY_UPDATED/30.45) + 1) AS Z_NUM_PERIODS_120 FROM F120_TABLE LEFT JOIN ACQUISITION_FILE_CAS 
                                     ON F120_TABLE.LOAN_ID = ACQUISITION_FILE_CAS.LOAN_ID")
```

```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE ORIG_MATURITY_TABLE_S1 AS 
                                     SELECT LOAN_ID, MIN(PERIOD) AS MATURITY_DATE_PERIOD 
                                     FROM SLIM_PERFORMANCE_FILE   
                                     WHERE MATURITY_DATE IS NOT NULL
                                     GROUP BY LOAN_ID;")
cas.fedSql.execDirect(conn, query = "CREATE TABLE ORIG_MATURITY_TABLE AS 
                                     SELECT SLIM_PERFORMANCE_FILE.LOAN_ID, 
                                     ORIG_MATURITY_TABLE_S1.MATURITY_DATE_PERIOD AS ORIG_MATURITY_DATE
                                     FROM ORIG_MATURITY_TABLE_S1 LEFT JOIN SLIM_PERFORMANCE_FILE 
                                     ON SLIM_PERFORMANCE_FILE.LOAN_ID = ORIG_MATURITY_TABLE_S1.LOAN_ID AND SLIM_PERFORMANCE_FILE.PERIOD = ORIG_MATURITY_TABLE_S1.MATURITY_DATE_PERIOD;")
cas.table.dropTable(conn, name = 'ORIG_MATURITY_TABLE_S1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'ORIG_MATURITY_TABLE', caslib = "RCASLIB"), to = 1000)
```

```{r}
cas.dataStep.runCode(conn, code = "data RCASLIB.TRM_CHNG_TABLE_S1; 
                                      set RCASLIB.SLIM_PERFORMANCE_FILE;
                                      BY LOAN_ID PERIOD;
                                      PREV_REM_MTHS = LAG(REM_MTHS);
                                      if first.loan_id then prev_rem_mths = .;
                                      if prev_rem_mths ne . and rem_mths ne . then trm_chng = rem_mths - prev_rem_mths;
                                      if trm_chng >= 0 then did_trm_chng = 1;
                                      else did_trm_chng = 0;
                                      keep loan_id period did_trm_chng;
                                    run;")
cas.fedSql.execDirect(conn, query = "CREATE TABLE TRM_CHNG_TABLE AS SELECT MIN(PERIOD) AS TRM_CHNG_DTE, LOAN_ID, 1 AS DID_TRM_CHNG_NEW 
                                     FROM RCASLIB.TRM_CHNG_TABLE_S1 WHERE DID_TRM_CHNG = 1 GROUP BY LOAN_ID")
cas.table.dropTable(conn, name = 'TRM_CHNG_TABLE_S1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'TRM_CHNG_TABLE', caslib = "RCASLIB"), to = 1000)
```


```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE MODTRM_TABLE_P1 AS SELECT FMOD_P3.LOAN_ID, FMOD_P3.FMOD_UPB, FMOD_P3.FMOD_DTE,
                                     ORIG_MATURITY_TABLE.ORIG_MATURITY_DATE, FMOD_P3.maturity_date FROM FMOD_P3 LEFT JOIN ORIG_MATURITY_TABLE ON
                                     FMOD_P3.LOAN_ID = ORIG_MATURITY_TABLE.LOAN_ID")
cas.fedSql.execDirect(conn, query = "CREATE TABLE MODTRM_TABLE AS SELECT MODTRM_TABLE_P1.LOAN_ID, 
                                     CASE 
                                         WHEN (MODTRM_TABLE_P1.ORIG_MATURITY_DATE != MODTRM_TABLE_P1.maturity_date) OR TRM_CHNG_TABLE.TRM_CHNG_DTE IS NOT NULL THEN 1
                                         ELSE 0
                                     END AS MODTRM_CHNG FROM MODTRM_TABLE_P1 LEFT JOIN TRM_CHNG_TABLE 
                                     ON MODTRM_TABLE_P1.LOAN_ID = TRM_CHNG_TABLE.LOAN_ID;")
cas.table.dropTable(conn, name = 'MODTRM_TABLE_P1', caslib = "RCASLIB")
cas.table.dropTable(conn, name = 'ORIG_MATURITY_TABLE', caslib = "RCASLIB")
cas.table.dropTable(conn, name = 'TRM_CHNG_TABLE', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'MODTRM_TABLE', caslib = "RCASLIB"), to = 1000)
```

```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE PRE_MOD_P1 AS SELECT MAX(PERIOD) AS PRE_MOD_PERIOD, LOAN_ID FROM SLIM_PERFORMANCE_FILE GROUP BY LOAN_ID")
cas.fedSql.execDirect(conn, query = "CREATE TABLE PRE_MOD_UPB_TABLE_1 AS SELECT PRE_MOD_P1.*, 
                                     FMOD_P3.FMOD_DTE, FMOD_P3.FMOD_UPB 
                                     FROM PRE_MOD_P1 LEFT JOIN FMOD_P3 ON
                                     PRE_MOD_P1.LOAN_ID = FMOD_P3.LOAN_ID
                                     WHERE PRE_MOD_PERIOD <= FMOD_DTE;")
cas.fedSql.execDirect(conn, query = "CREATE TABLE PRE_MOD_UPB_TABLE AS 
                                     SELECT PRE_MOD_UPB_TABLE_1.*, SLIM_PERFORMANCE_FILE.ACT_UPB AS PRE_MOD_UPB 
                                     FROM PRE_MOD_UPB_TABLE_1 LEFT JOIN SLIM_PERFORMANCE_FILE 
                                     ON SLIM_PERFORMANCE_FILE.LOAN_ID = PRE_MOD_UPB_TABLE_1.LOAN_ID 
                                    AND SLIM_PERFORMANCE_FILE.PERIOD = PRE_MOD_UPB_TABLE_1.PRE_MOD_PERIOD;")
cas.table.dropTable(conn, name = 'PRE_MOD_UPB_TABLE_1', caslib = "RCASLIB")
cas.table.dropTable(conn, name = 'PRE_MOD_P1', caslib = "RCASLIB")
cas.table.fetch(conn, table = list(name = 'PRE_MOD_UPB_TABLE', caslib = "RCASLIB"), to = 1000)
```

```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE MODUPB_TABLE AS SELECT PRE_MOD_UPB_TABLE.LOAN_ID, 
                                     CASE
                                         WHEN FMOD_P3.FMOD_UPB >= PRE_MOD_UPB_TABLE.PRE_MOD_UPB THEN 1
                                         ELSE 0
                                     END AS MODUPB_CHNG FROM FMOD_P3 LEFT JOIN PRE_MOD_UPB_TABLE 
                                     ON FMOD_P3.LOAN_ID = PRE_MOD_UPB_TABLE.LOAN_ID;")
```

```{r}
cas.fedSql.execDirect(conn, query = "CREATE TABLE BASETABLE_4_P1 AS 
                                     SELECT BASETABLE_3.*, 
                                     F30_TABLE.F30_DTE, F30_TABLE.F30_UPB, 
                                     F60_TABLE.F60_DTE, F60_TABLE.F60_UPB,
                                     F90_TABLE.F90_DTE, F90_TABLE.F90_UPB,
                                     F120_TABLE.F120_DTE, F120_TABLE.F120_UPB,
                                     F180_TABLE.F180_DTE, F180_TABLE.F180_UPB,
                                     FCE_TABLE.FCE_DTE, FCE_TABLE.FCE_UPB,
                                     FMOD_P3.FMOD_DTE, FMOD_P3.FMOD_UPB, FMOD_P3.MATURITY_DATE AS FMOD_MATURITY_DTE,
                                     NUM_120_TABLE.Z_NUM_PERIODS_120,
                                     MODTRM_TABLE.MODTRM_CHNG,
                                     MODUPB_TABLE.MODUPB_CHNG
                                     FROM BASETABLE_3 
                                      LEFT JOIN F30_TABLE ON F30_TABLE.LOAN_ID = BASETABLE_3.LOAN_ID
                                      LEFT JOIN F60_TABLE ON F60_TABLE.LOAN_ID = BASETABLE_3.LOAN_ID
                                      LEFT JOIN F90_TABLE ON F90_TABLE.LOAN_ID = BASETABLE_3.LOAN_ID
                                      LEFT JOIN F120_TABLE ON F120_TABLE.LOAN_ID = BASETABLE_3.LOAN_ID
                                      LEFT JOIN F180_TABLE ON F180_TABLE.LOAN_ID = BASETABLE_3.LOAN_ID
                                      LEFT JOIN FCE_TABLE ON FCE_TABLE.LOAN_ID = BASETABLE_3.LOAN_ID
                                      LEFT JOIN FMOD_P3 ON FMOD_P3.LOAN_ID = BASETABLE_3.LOAN_ID
                                      LEFT JOIN NUM_120_TABLE ON NUM_120_TABLE.LOAN_ID = BASETABLE_3.LOAN_ID
                                      LEFT JOIN MODTRM_TABLE ON MODTRM_TABLE.LOAN_ID = BASETABLE_3.LOAN_ID
                                      LEFT JOIN MODUPB_TABLE ON MODUPB_TABLE.LOAN_ID = BASETABLE_3.LOAN_ID")

cas.fedSql.execDirect(conn, query = "CREATE TABLE BASETABLE_4 AS SELECT ORIG_AMT, NON_INT_UPB_NEW, SERVICER_NEW, SERVICER_PERIOD, LAST_ACTIVITY_DATE, LOAN_ID, PERIOD, SERVICER,
                                     ACT_UPB, LOAN_AGE, REM_MTHS, ADJ_REM_MONTHS, MSA, FCC_COST, 
                                     CASE
                                        WHEN F30_UPB IS NULL AND F30_DTE IS NOT NULL THEN ORIG_AMT 
                                        ELSE F30_UPB
                                     END AS F30_UPB,
                                     CASE
                                        WHEN F60_UPB IS NULL AND F60_DTE IS NOT NULL THEN ORIG_AMT 
                                        ELSE F60_UPB
```


```{r}
END AS F60_UPB,
                                     CASE
                                        WHEN F90_UPB IS NULL AND F90_DTE IS NOT NULL THEN ORIG_AMT 
                                        ELSE F90_UPB
                                     END AS F90_UPB,
                                     CASE
                                        WHEN F120_UPB IS NULL AND F120_DTE IS NOT NULL THEN ORIG_AMT 
                                        ELSE F120_UPB
                                     END AS F120_UPB,
                                     CASE
                                        WHEN F180_UPB IS NULL AND F180_DTE IS NOT NULL THEN ORIG_AMT 
                                        ELSE F180_UPB
                                     END AS F180_UPB,
                                     CASE
                                        WHEN FCE_UPB IS NULL AND FCE_DTE IS NOT NULL THEN ORIG_AMT 
                                        ELSE FCE_UPB
                                     END AS FCE_UPB 
                                     FROM BASETABLE_4_P1;")

cas.table.fetch(conn, table = list(name = 'BASETABLE_4', caslib = "RCASLIB"), to = 1000)
```
```{r}
cas.table.promote(caslib = 'CASUSER', name = "ACQFIRSTPERIOD")
```
```{r}
cas.table.fetch(conn, table = list(name = 'BASETABLE_4', caslib = "RCASLIB"), to = 1000)
```
```{r}
cas.table.fetch(conn, table = list(name = 'BASETABLE_4', caslib = "RCASLIB"), to = 1000)

```


```{r}
# cas.terminate(conn)
# endtime <- Sys.time()
# print(endtime - start_time)
```


```{r}
cas.table.promote(conn, caslib = "RCASLIB", name = "ACQFIRSTPERIOD", targetLib="CASUSER")
##cas.table.promote(conn, caslib = "RCASLIB", name = "ACQUISITION_FILE_CAS", targetLib="CASUSER")
##cas.table.promote(conn, caslib = "RCASLIB", name = "BASETABLE_3", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "BASETABLE_4", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "BASETABLE_4_P1", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "BASETABLE1", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "F120_TABLE", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "F180_TABLE", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "F30_TABLE", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "F60TABLE", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "F90_TABLE", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "FCE_TABLE", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "FMOD_P3", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "MODTRN_TABLE", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "MODUPB_TABLE", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "NUM_120_TABLE", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "PERFORMANCE_FILE_CAS", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "PRE_MOD_UPB_TABLE", targetLib="CASUSER")
# cas.table.promote(conn, caslib = "RCASLIB", name = "SLIM_PERFORMANCE_FILE", targetLib="CASUSER")

















```

```{r}
cas.table.fileInfo(conn, caslib = "RCASLIB")
```

```{r}

```

```{r}

```


```{r}

```

```{r}

```